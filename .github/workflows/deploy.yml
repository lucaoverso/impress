name: Deploy no servidor

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Atualizar código no servidor
        run: |
          sudo -n -u sistema-impress rm -f /opt/sistema-impress/.git/index.lock || true
          sudo -n -u sistema-impress git -C /opt/sistema-impress config --global --add safe.directory /opt/sistema-impress
          sudo -n -u sistema-impress git -C /opt/sistema-impress fetch --all --prune
          sudo -n -u sistema-impress git -C /opt/sistema-impress reset --hard origin/main
          sudo -n -u sistema-impress git -C /opt/sistema-impress clean -fd

      - name: Reiniciar serviços
        run: |
          sudo -n systemctl restart sistema-impress-api.service
          sudo -n systemctl restart sistema-impress-worker.service